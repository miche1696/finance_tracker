{% extends 'expenses/base.html' %}

{% block title %}Expense List{% endblock %}

{% block content %}
{% csrf_token %}
<div class="expense-dashboard">
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header">
            <h1><i class="bi bi-list-ul"></i> Expense List</h1>
            <div class="header-actions">
                <a href="{% url 'expenses:import' %}" class="btn btn-info me-2">
                    <i class="bi bi-upload"></i> Import from CSV
                </a>
                <a href="{% url 'expenses:add' %}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Add New Expense
                </a>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <form method="get" class="filters-form" id="filterForm">
                <div class="filters-toolbar">
                    <!-- Date Range Filter -->
                    <div class="filter-item">
                        <div class="filter-icon">
                            <i class="bi bi-calendar3"></i>
                        </div>
                        <div class="filter-inputs">
                            <input type="date" name="date_after" value="{{ filter.form.date_after.value|default:'' }}" 
                                   class="form-control form-control-sm" placeholder="From">
                            <span class="filter-separator">to</span>
                            <input type="date" name="date_before" value="{{ filter.form.date_before.value|default:'' }}" 
                                   class="form-control form-control-sm" placeholder="To">
                        </div>
                    </div>

                    <!-- Amount Range Filter -->
                    <div class="filter-item">
                        <div class="filter-icon">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="filter-inputs">
                            <input type="number" name="amount_min" value="{{ filter.form.amount_min.value|default:'' }}" 
                                   class="form-control form-control-sm" placeholder="Min" step="0.01" min="0">
                            <span class="filter-separator">to</span>
                            <input type="number" name="amount_max" value="{{ filter.form.amount_max.value|default:'' }}" 
                                   class="form-control form-control-sm" placeholder="Max" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Filter Actions -->
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-search"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" title="Reset all filters" id="clearFilters">
                            <i class="bi bi-arrow-clockwise"></i> Reset Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>



        <!-- Expense List -->
        <div class="expense-list-section">
            {% if object_list %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th><i class="bi bi-calendar3"></i> Date</th>
                                <th><i class="bi bi-shop"></i> Vendor</th>
                                <th><i class="bi bi-tag"></i> Category</th>
                                <th><i class="bi bi-folder2-open"></i> Subcategory</th>
                                <th><i class="bi bi-currency-dollar"></i> Amount</th>
                                <th><i class="bi bi-gear"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in object_list %}
                            <tr class="{% if expense.amount > 100 %}high-expense{% endif %}">
                                <td>{{ expense.date|date:"M d, Y" }}</td>
                                <td>{{ expense.vendor }}</td>
                                <td>{{ expense.category }}</td>
                                <td>{{ expense.subcategory|default:"â€”" }}</td>
                                <td class="amount-cell">${{ expense.amount|floatformat:2 }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'expenses:edit' expense.id %}" class="btn btn-outline-primary btn-sm" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm delete-expense-btn" 
                                                title="Delete" 
                                                data-expense-id="{{ expense.id }}"
                                                data-expense-vendor="{{ expense.vendor }}"
                                                data-expense-amount="{{ expense.amount }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary -->
                <div class="expense-summary">
                    <div class="summary-item">
                        <span class="summary-label">Total Expenses:</span>
                        <span class="summary-value">{{ object_list|length }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Amount:</span>
                        <span class="summary-value">${{ total_amount|floatformat:2 }}</span>
                    </div>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h4>No expenses found</h4>
                    <p>Try adjusting your filters or add your first expense.</p>
                    <a href="{% url 'expenses:add' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add First Expense
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.expense-dashboard {
    height: 100%;
}



.main-content {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    background: white;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.content-header h1 {
    margin: 0;
    font-size: 1.5rem;
    color: #495057;
}

.filters-section {
    background: white;
    border-bottom: 1px solid #dee2e6;
}

.filters-toolbar {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    align-items: center;
    background: #f8f9fa;
    border-radius: 0.5rem;
    border: 1px solid #e9ecef;
}

.filter-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    min-width: 180px;
    max-width: 300px;
}

.filter-icon {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.filter-icon i {
    font-size: 1.1rem;
    color: #6c757d;
}

.filter-inputs {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    flex: 1;
    min-width: 0;
}

.filter-inputs input[type="date"],
.filter-inputs input[type="number"] {
    flex: 1;
    min-width: 0;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.filter-inputs input[type="date"] label,
.filter-inputs input[type="number"] label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.filter-separator {
    font-size: 0.875rem;
    color: #6c757d;
    margin: 0 0.25rem;
    font-weight: 500;
}

.dropdown-container {
    position: relative;
}

.dropdown-menu {
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    margin-top: 0.25rem;
    min-width: 200px;
}

.dropdown-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: #495057;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    transition: background-color 0.15s ease-in-out;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    color: #495057;
}

.dropdown-item.active {
    background-color: #007bff;
    color: white;
}

.dropdown-item input[type="checkbox"] {
    margin-right: 0.5rem;
    width: 16px;
    height: 16px;
}

.filter-actions {
    display: flex;
    gap: 0.5rem;
    margin-left: auto;
}

.expense-list-section {
    flex: 1;
    overflow: auto;
}

.table {
    margin-bottom: 0;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.amount-cell {
    font-weight: 600;
    color: #28a745;
}



.high-expense {
    background-color: #fff3cd !important;
}

.high-expense .amount-cell {
    color: #856404 !important;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #dee2e6;
}

.empty-state h4 {
    margin-bottom: 0.5rem;
    color: #495057;
}

.expense-summary {
    display: flex;
    gap: 2rem;
    padding: 1rem;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    margin-top: 1rem;
}

.summary-item {
    display: flex;
    flex-direction: column;
}

.summary-label {
    font-size: 0.8rem;
    color: #6c757d;
}

.summary-value {
    font-weight: 600;
    color: #495057;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .filters-toolbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }

    .filter-item {
        flex: none;
        width: 100%;
        max-width: none;
    }

    .filter-inputs {
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-inputs input[type="date"],
    .filter-inputs input[type="number"] {
        flex: none;
        width: 100%;
    }
    
    .filter-actions {
        margin-left: 0;
        justify-content: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Starting script execution');
    
    // Get form and button references
    const filterForm = document.getElementById('filterForm');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    // Get input elements
    const dateAfterInput = document.querySelector('input[name="date_after"]');
    const dateBeforeInput = document.querySelector('input[name="date_before"]');
    const amountMinInput = document.querySelector('input[name="amount_min"]');
    const amountMaxInput = document.querySelector('input[name="amount_max"]');
    
    console.log('Input elements found:', {
        dateAfter: dateAfterInput,
        dateBefore: dateBeforeInput,
        amountMin: amountMinInput,
        amountMax: amountMaxInput
    });
    
    // Add event listener to clear filters button
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            console.log('Clear filters button clicked');
            
            // Clear all filter inputs
            if (dateAfterInput) dateAfterInput.value = '';
            if (dateBeforeInput) dateBeforeInput.value = '';
            if (amountMinInput) amountMinInput.value = '';
            if (amountMaxInput) amountMaxInput.value = '';
            
            // Submit the form to apply the cleared filters
            if (filterForm) {
                filterForm.submit();
            }
        });
    }
    
    // Delete expense functionality
    const deleteButtons = document.querySelectorAll('.delete-expense-btn');
    
    deleteButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const expenseId = this.getAttribute('data-expense-id');
            const expenseVendor = this.getAttribute('data-expense-vendor');
            const expenseAmount = this.getAttribute('data-expense-amount');
            
            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to delete the expense "${expenseVendor}" for $${expenseAmount}?\n\nThis action cannot be undone.`);
            
            if (confirmed) {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/expenses/delete/${expenseId}/`;
                
                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken.value;
                    form.appendChild(csrfInput);
                }
                
                // Submit the form
                document.body.appendChild(form);
                form.submit();
            }
        });
    });
});
</script>
{% endblock %} 